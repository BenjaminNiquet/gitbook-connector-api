## Device integrations

In order to communicate with devices on the local hotel network, such as printers, lock systems, PBX, TVs, key cutters or fiscal machines, Mews has introduced the concept of devices and device commands. When a relevant action happens in Mews, a device command is generated and put into the device command queue. Using the API, you can pull the commands from the queue, process them as you find necessary and later mark them as processed. Of course, as many of the actions with devices should happen in real time, you should in most of the cases use this in combination with [Websockets](../websockets.md) to avoid polling for new commands. Whenever a relevant command is created, you would receive a notification about such an event through the opened websocket.

### Adding a new device 

When a new device has been created in Mews and linked to your integration, you should disconnect and reconnect to the websocket in order to receive websocket events for the newly added devices. 

### Retrieving commands 

First, subscribe your application to receive device command events by connecting to the Websockets endpoint. Once the websocket connection has been established, your application will receive notification of all newly created device commands in real time.  

Once you are notified of a new or updated [Command event](../websockets.md#command-event), retrieve the command into your application using [Get all commands by ids](../operations/integrations.md#get-all-commands-by-ids). 

If your application reconnects using websockets or was offline for any reason and length of time, you should use the [Get all commands](../operations/integrations.md#get-all-commands) operation to retrieve all pending commands that were in the queue while your application was offline. This is to ensure that no commands in the queue remain unprocessed.  

### Processing commands 

Once your application has successfully processed the device command, you should update the status of the command to “Processed” (or others if the command was not successfully processed) using the [Update command](../operations/integrations.md#update-command) operation. 

### Types of device commands

Mews currently provides several types of [Command data](../operations/integrations.md#command-data), including printer, payment terminal, passport scanner, fiscal machine, and key cutter command data.

#### Fiscal machine commands

For Fiscal Machines (whether a virtual or a physical one), you will receive a command containing [Fiscal machine command data](../operations/integrations.md#fiscal-machine-command-data). That includes all data of the related [Bill](../operations/finance.md#bill) including all the payments and revenue items in a form of [Accounting item](../operations/finance.md#accounting-item). 
*NB: Currently, there is no way to send fiscal codes generated by the fiscal machine back to Mews.*

#### Key cutter commands

In case your device is a Key Cutter, you will get a command containing [Key cutter command data](../operations/integrations.md#key-cutter-command-data). You can then use this set of information to encode a physical key card. If your solution includes both physical keys and mobile/other forms of keys, you can also use the same set of information to send the key or door code to the guest.  

### Testing your integration

Ensure you follow our general [guidelines](../guidelines.md) for testing integrations. In addition to this, and specific to Device integrations:

To be able to use your device integration, an additional step of configuring the device and connecting it to the relevant API access token is required. This is done through the following steps:

1. Open the main menu in the top left corner, scroll down and click on **Marketplace**.
2. Depending on the type of device you are connecting, click on either Facility management (Key cutter integration, Passport scanner integration, Printer integration) or Legal environment (Fiscal machine integration) categories.
3. Once you've found the correct device integration, click **See more** followed by **Connect** to generate this device integration.
4. Complete the required fields (if any) in the main settings page of the device integration, then click on the device type on the left side of the screen (e.g. Key cutters) and then the "+" button to add and configure the device. Be sure to save all changes. 
5. Go back to your integration found in the **My subscriptions** section of the Marketplace and click on the **Settings** found on the right side of the integration listing.
6. Once inside the integration settings page, you will see a drop down menu titled **Connected devices**. Select your newly created device from that list and click **Save**.

This is the same process that will be required when you assist any new mutual client with onboarding and configuration of your solution.

For a full overview of device commands and their states, you can check the [device commands queue](https://intercom.help/mews-systems/en/articles/4245952-device-commands-queue) in Mews. If you are returning an unexpected error indicating there is an issue with the Data JSON, please read [this article](https://intercom.help/mews-systems/en/articles/4394724-data-json-incorrect-or-unsupported-device) to understand what this indicates, based on the type of integration you are referring to.
